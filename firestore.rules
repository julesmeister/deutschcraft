rules_version = '2';

// ============================================================================
// FIRESTORE INDEXES REQUIRED
// ============================================================================
// NOTE: Indexes are defined in firestore.indexes.json
// Deploy with: firebase deploy --only firestore:indexes
//
// Required composite indexes:
// 1. users: [role, userId] - for role management pagination
// 2. users: [teacherId, batchId] - for teacher's students by batch
// 3. users: [teacherId, role] - for teacher's students by role
// 4. batches: [teacherId, isActive, startDate] - for active batches
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(email) {
      return request.auth.token.email == email;
    }

    function isTeacher() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role == 'TEACHER';
    }

    function isStudent() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role == 'STUDENT';
    }

    function isPendingApproval() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.role == 'PENDING_APPROVAL';
    }

    // ============================================================================
    // PUBLIC READS (for landing page and public resources)
    // ============================================================================

    // Allow public read access to pricing data (for landing page)
    match /pricing/{document=**} {
      allow read: if true;  // Anyone can read pricing
      allow write: if isTeacher();
    }

    // Allow public read access to syllabus data (for public syllabus page)
    match /syllabus/{document=**} {
      allow read: if true;  // Anyone can read syllabus
      allow write: if isTeacher();
    }

    // Public grammar resources
    match /grammar/{document=**} {
      allow read: if true;  // Anyone can read grammar guides
      allow write: if isTeacher();
    }

    // Public vocabulary lists
    match /vocabulary/{document=**} {
      allow read: if true;  // Anyone can browse vocabulary
      allow write: if isTeacher();
    }

    // ============================================================================
    // AUTHENTICATED USER RULES
    // ============================================================================

    // Users collection
    match /users/{email} {
      // Anyone authenticated can read their own user document
      allow read: if isAuthenticated() && isOwner(email);

      // Teachers can read all users (for student management)
      allow read: if isTeacher();

      // Users can create their own document (first-time login)
      allow create: if isAuthenticated() && isOwner(email);

      // Users can update their own document
      allow update: if isAuthenticated() && isOwner(email);

      // Teachers can update any user document (for approval, assignments, etc.)
      allow update: if isTeacher();

      // Users can delete their own account (only if unapproved)
      allow delete: if isAuthenticated() &&
                      isOwner(email) &&
                      resource.data.role == 'PENDING_APPROVAL';

      // Teachers can delete pending approval users
      allow delete: if isTeacher() && resource.data.role == 'PENDING_APPROVAL';
    }

    // Batches collection
    match /batches/{batchId} {
      // Teachers can read/write batches
      allow read, write: if isTeacher();

      // Students can read their own batch
      allow read: if isStudent() &&
                    get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.batchId == batchId;

      // Pending users can read batches (for browsing)
      allow read: if isPendingApproval();
    }

    // Flashcards - Students can read based on their CEFR level
    match /flashcards/{level}/{document=**} {
      // All authenticated users can read flashcards
      allow read: if isAuthenticated();

      // Teachers can manage flashcards
      allow write: if isTeacher();
    }

    // Legacy flashcards path
    match /flashcards/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }

    // Student progress/stats
    match /studentProgress/{email}/{document=**} {
      // Students can read/write their own progress
      allow read, write: if isAuthenticated() && isOwner(email);

      // Teachers can read and write student progress
      allow read, write: if isTeacher();
    }

    // Flashcard sessions (practice sessions)
    match /flashcardSessions/{sessionId} {
      // Users can create their own sessions
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Users can read/update their own sessions
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read all sessions
      allow read: if isTeacher();
    }

    // Writing submissions (with hyphen)
    match /writing-submissions/{submissionId} {
      // Students can create submissions
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Students can read their own submissions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Students can update their own ungraded submissions
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.token.email &&
                      resource.data.status != 'reviewed';

      // Teachers can read all submissions and update (for grading)
      allow read, update: if isTeacher();
    }

    // Legacy writing submissions (without hyphen)
    match /writingSubmissions/{submissionId} {
      // Students can create submissions
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Students can read their own submissions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Students can update their own ungraded submissions
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.token.email &&
                      resource.data.status != 'reviewed';

      // Teachers can read all submissions and update (for grading)
      allow read, update: if isTeacher();
    }

    // Writing stats
    match /writing-stats/{userId} {
      // Students can read their own stats
      allow read: if isAuthenticated() && isOwner(userId);

      // Students can write their own stats (for auto-updates)
      allow write: if isAuthenticated() && isOwner(userId);

      // Teachers can read and write all stats
      allow read, write: if isTeacher();
    }

    // Writing review quizzes (fill-in-the-blank exercises)
    match /writing-review-quizzes/{quizId} {
      // Students can create their own quiz attempts
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Students can read their own quiz attempts
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read all quiz attempts
      allow read: if isTeacher();
    }

    // Mini exercise sentences (indexed sentences for practice)
    match /mini-exercise-sentences/{sentenceId} {
      // Students can read their own indexed sentences
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // System can create/update sentences (via service)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read all sentences
      allow read: if isTeacher();
    }

    // Mini exercise attempts (practice attempt records)
    match /mini-exercise-attempts/{attemptId} {
      // Students can create their own attempts
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Students can read their own attempts
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read all attempts
      allow read: if isTeacher();
    }

    // Writing progress (daily metrics)
    match /writing-progress/{progressId} {
      // Students can read/write their own progress
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.token.email;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Teachers can read all progress
      allow read: if isTeacher();
    }

    // Teacher reviews
    match /teacher-reviews/{reviewId} {
      // Students can read reviews of their submissions
      allow read: if isAuthenticated() && resource.data.studentId == request.auth.token.email;

      // Teachers can read and write all reviews
      allow read, write: if isTeacher();
    }

    // Peer reviews
    match /peer-reviews/{reviewId} {
      // Students can read reviews of their submissions
      allow read: if isAuthenticated() && resource.data.studentId == request.auth.token.email;

      // Students can create and update their own reviews
      allow create: if isAuthenticated() && request.resource.data.reviewerId == request.auth.token.email;
      allow update: if isAuthenticated() && resource.data.reviewerId == request.auth.token.email;

      // Teachers can read all peer reviews
      allow read: if isTeacher();
    }

    // Writing prompts
    match /writingPrompts/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }

    // Activities/Sessions (general learning activities)
    match /activities/{document=**} {
      allow read, write: if isAuthenticated();
    }

    match /sessions/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // Achievements/Badges
    match /achievements/{email}/{document=**} {
      // Users can read their own achievements
      allow read: if isAuthenticated() && isOwner(email);

      // Teachers can read/write all achievements
      allow read, write: if isTeacher();

      // System can write achievements (via Cloud Functions)
      allow write: if isAuthenticated() && isOwner(email);
    }

    // Notifications
    match /notifications/{email}/{document=**} {
      // Users can read/write their own notifications
      allow read, write: if isAuthenticated() && isOwner(email);

      // Teachers can create notifications for students
      allow create: if isTeacher();
    }

    // Analytics/Stats (aggregated data)
    match /analytics/{document=**} {
      // Teachers can read/write analytics
      allow read, write: if isTeacher();

      // Students can read their own stats
      allow read: if isAuthenticated();
    }

    // Assignments
    match /assignments/{assignmentId} {
      // Teachers can manage assignments
      allow read, write: if isTeacher();

      // Students can read assignments
      allow read: if isStudent();

      // Pending users can read assignments (for browsing)
      allow read: if isPendingApproval();
    }

    // Assignment submissions
    match /assignmentSubmissions/{submissionId} {
      // Students can create their own submissions
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Students can read/update their own submissions
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read/write all submissions
      allow read, write: if isTeacher();
    }

    // Teacher resources
    match /teacherResources/{document=**} {
      // Only teachers can access
      allow read, write: if isTeacher();
    }

    // Chat/Messages (for student-teacher communication)
    match /chats/{chatId}/messages/{messageId} {
      // Users can read messages in their chats
      allow read: if isAuthenticated() &&
                    request.auth.token.email in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

      // Users can create messages in their chats
      allow create: if isAuthenticated() &&
                      request.auth.token.email in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                      request.resource.data.senderId == request.auth.token.email;
    }

    match /chats/{chatId} {
      // Users can read their own chats
      allow read: if isAuthenticated() && request.auth.token.email in resource.data.participants;

      // Users can create chats they're part of
      allow create: if isAuthenticated() && request.auth.token.email in request.resource.data.participants;

      // Teachers can read all chats
      allow read: if isTeacher();
    }

    // Settings/Preferences
    match /userSettings/{email} {
      // Users can read/write their own settings
      allow read, write: if isAuthenticated() && isOwner(email);
    }

    // Study streaks
    match /streaks/{email} {
      // Users can read/write their own streak
      allow read, write: if isAuthenticated() && isOwner(email);

      // Teachers can read all streaks
      allow read: if isTeacher();
    }

    // Leaderboards (for gamification)
    match /leaderboards/{document=**} {
      // All authenticated users can read leaderboards
      allow read: if isAuthenticated();

      // Only system/teachers can write
      allow write: if isTeacher();
    }

    // Gantt Tasks (Schedule/Curriculum)
    match /gantt_tasks/{taskId} {
      // Teachers can read/write all gantt tasks
      allow read, write: if isTeacher();

      // Students with permission can read/write (check expiration)
      allow read, write: if isAuthenticated() &&
                           exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
                           get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.ganttEditPermission == true &&
                           (get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.ganttEditExpiresAt == null ||
                            get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.ganttEditExpiresAt > request.time.toMillis());

      // Students can read gantt tasks for their assigned batch
      allow read: if isStudent() &&
                    exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
                    resource.data.parentTaskId == get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.batchId;

      // All authenticated users can read (view-only for students without permission)
      allow read: if isAuthenticated();
    }

    // ============================================================================
    // SOCIAL MEDIA FEATURES
    // ============================================================================

    // Posts - Students and teachers can create and view posts
    match /posts/{postId} {
      // Anyone authenticated can read public posts
      allow read: if isAuthenticated();

      // Students and teachers can create posts
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Users can update their own posts
      allow update: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can update any post (for moderation)
      allow update: if isTeacher();

      // Users can delete their own posts
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can delete any post (for moderation)
      allow delete: if isTeacher();
    }

    // Comments - on posts
    match /comments/{commentId} {
      // Anyone authenticated can read comments
      allow read: if isAuthenticated();

      // Users can create comments
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Users can update their own comments
      allow update: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Users can delete their own comments
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can delete any comment (for moderation)
      allow delete: if isTeacher();
    }

    // Suggestions - corrections for posts
    match /suggestions/{suggestionId} {
      // Post authors and suggestion creators can read
      allow read: if isAuthenticated() &&
                    (resource.data.suggestedBy == request.auth.token.email ||
                     resource.data.suggestedTo == request.auth.token.email);

      // All authenticated users can read (for learning)
      allow read: if isAuthenticated();

      // Users can create suggestions on others' posts (not their own)
      allow create: if isAuthenticated() &&
                      request.resource.data.suggestedBy == request.auth.token.email &&
                      request.resource.data.suggestedBy != request.resource.data.suggestedTo;

      // Post authors can update suggestions (accept/reject)
      allow update: if isAuthenticated() && resource.data.suggestedTo == request.auth.token.email;

      // Suggestion creators can update their own suggestions (before accepted)
      allow update: if isAuthenticated() &&
                      resource.data.suggestedBy == request.auth.token.email &&
                      resource.data.status == 'pending';

      // Anyone can update to vote (upvote/downvote)
      allow update: if isAuthenticated();

      // Teachers can update any suggestion
      allow update: if isTeacher();

      // Suggestion creators can delete their pending suggestions
      allow delete: if isAuthenticated() &&
                      resource.data.suggestedBy == request.auth.token.email &&
                      resource.data.status == 'pending';

      // Teachers can delete any suggestion
      allow delete: if isTeacher();
    }

    // Likes - for posts and comments
    match /likes/{likeId} {
      // Users can read their own likes
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Anyone can read likes (for counts)
      allow read: if isAuthenticated();

      // Users can create their own likes
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Users can delete their own likes (unlike)
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.token.email;
    }

    // Shares - post sharing
    match /shares/{shareId} {
      // Anyone authenticated can read shares
      allow read: if isAuthenticated();

      // Users can create shares
      allow create: if isAuthenticated() && request.resource.data.sharedBy == request.auth.token.email;

      // Users can delete their own shares
      allow delete: if isAuthenticated() && resource.data.sharedBy == request.auth.token.email;
    }

    // Poll votes
    match /pollVotes/{voteId} {
      // Users can read poll results
      allow read: if isAuthenticated();

      // Users can create their own votes
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;

      // Users can update their own votes (change vote)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.token.email;
    }

    // Post edit history - track all post edits
    match /postEditHistory/{editId} {
      // Post authors can read their edit history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.token.email;

      // Teachers can read all edit history
      allow read: if isTeacher();

      // System creates edit history automatically
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.token.email;
    }

    // ============================================================================
    // EXERCISE OVERRIDES (Teacher customizations to Answer Hub exercises)
    // ============================================================================

    // Exercise overrides - teachers can customize exercises globally
    match /exercise-overrides/{overrideId} {
      // Teachers can read/write their own overrides
      allow read, write: if isTeacher() &&
                            resource.data.teacherEmail == request.auth.token.email;

      // Teachers can create overrides for themselves
      allow create: if isTeacher() &&
                      request.resource.data.teacherEmail == request.auth.token.email;

      // Students can read their teacher's overrides
      allow read: if isStudent() &&
                    exists(/databases/$(database)/documents/users/$(request.auth.token.email)) &&
                    resource.data.teacherEmail == get(/databases/$(database)/documents/users/$(request.auth.token.email)).data.teacherId;
    }

    // ============================================================================
    // ALLOW ALL FOR DEVELOPMENT (Comment out in production)
    // ============================================================================

    // Catch-all for any other collections - allow if authenticated
    // This makes development easier but should be restricted in production
    match /{collection}/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
