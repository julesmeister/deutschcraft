# Multiple Attempts System

**Last Updated**: 2025-11-12

## Overview

Students can submit **multiple attempts** for the same exercise. Each attempt:
- Is stored as a separate Firestore document
- Has its own attempt number (1, 2, 3, ...)
- Can receive independent teacher and peer reviews
- Tracks separate scores and feedback

## Data Model

### WritingSubmission (Updated)

```typescript
interface WritingSubmission {
  submissionId: string;
  exerciseId: string;
  userId: string;
  attemptNumber: number; // NEW: 1, 2, 3, etc.

  content: string;
  wordCount: number;
  status: 'draft' | 'submitted' | 'reviewed';

  // Each attempt can be reviewed independently
  teacherScore?: number;
  teacherFeedback?: string;
  // ... other fields
}
```

### Key Fields

| Field | Description | Example |
|-------|-------------|---------|
| `attemptNumber` | Sequential attempt counter | 1, 2, 3, 4... |
| `exerciseId` | Links to specific exercise | `"creative-a1-001"` |
| `userId` | Student's email | `"student@example.com"` |
| `status` | Attempt status | `'draft'`, `'submitted'`, `'reviewed'` |

### Firestore Document IDs

- **Document ID**: Auto-generated by Firestore (unique per attempt)
- **Query by**: `userId` + `exerciseId` + `attemptNumber`

Example documents for one exercise:
```
writing-submissions/
  ‚îú‚îÄ‚îÄ abc123 (userId: student@test.com, exerciseId: ex-001, attemptNumber: 1)
  ‚îú‚îÄ‚îÄ def456 (userId: student@test.com, exerciseId: ex-001, attemptNumber: 2)
  ‚îî‚îÄ‚îÄ ghi789 (userId: student@test.com, exerciseId: ex-001, attemptNumber: 3)
```

## Flow Diagrams

### Creating a New Attempt

```
Student selects exercise
  ‚Üì
Check for existing draft (hasDraftAttempt)
  ‚Üì
If draft exists:
  ‚Üí Resume existing draft
  ‚Üí Keep same attemptNumber
Else:
  ‚Üí Get next attempt number (getNextAttemptNumber)
  ‚Üí Create new draft with attemptNumber = n+1
  ‚Üì
Student writes
  ‚Üì
Student clicks "Save Draft"
  ‚Üí Updates draft document
  ‚Üì
Student clicks "Submit for Review"
  ‚Üí Changes status from 'draft' to 'submitted'
  ‚Üí Sets submittedAt timestamp
  ‚Üì
Teacher/peers can now review
```

### Reviewing Multiple Attempts

```
Teacher views student's writing exercises
  ‚Üì
Sees list of ALL attempts for each exercise
  ‚Üì
Teacher selects specific attempt to review
  ‚Üì
Provides feedback and score for THAT attempt
  ‚Üì
Student can see feedback for each attempt separately
  ‚Üì
Student can submit NEW attempt if they want to improve
```

## Services

### writingAttemptService.ts

**Purpose**: Manage multiple attempts logic

**Functions**:
1. **`getNextAttemptNumber(userId, exerciseId)`**
   - Returns next attempt number (1 for first, 2 for second, etc.)
   - Queries all existing submissions
   - Increments highest attempt number

2. **`getUserExerciseAttempts(userId, exerciseId)`**
   - Returns ALL attempts for a user/exercise combo
   - Sorted by attempt number

3. **`getLatestAttempt(userId, exerciseId)`**
   - Returns most recent attempt
   - Used to show "Continue from where you left off"

4. **`hasDraftAttempt(userId, exerciseId)`**
   - Checks if user has an unsaved draft
   - Returns draft to resume (prevents duplicate drafts)

5. **`getAttemptStats(userId, exerciseId)`**
   - Calculates statistics across all attempts:
     - Total attempts
     - Reviewed attempts
     - Average score
     - Best score
     - Latest score

## Components

### AttemptHistory.tsx

Displays all attempts for an exercise in a timeline format:
- Attempt number
- Status (draft, submitted, reviewed)
- Word count
- Submission date
- Teacher score (if reviewed)
- Teacher feedback preview
- "View" button to see full details

### AttemptStats.tsx

Shows aggregate statistics across all attempts:
- Total attempts made
- Number reviewed
- Average score across all attempts
- Best score achieved
- Latest score (most recent attempt)

## Hooks

### useWritingAttempts.ts

React Query hooks for attempt data:

```typescript
// Get all attempts for an exercise
const { data: attempts } = useExerciseAttempts(userId, exerciseId);

// Get latest attempt
const { data: latestAttempt } = useLatestAttempt(userId, exerciseId);

// Get statistics
const { data: stats } = useAttemptStats(userId, exerciseId);
```

## Progress Tracking

### How Stats Are Updated

**Important**: Each attempt increments completion counters, but scores are averaged across reviewed attempts only.

```
Student submits Attempt #1
  ‚Üì
Daily Progress:
  - exercisesCompleted += 1
  - totalWordsWritten += wordCount
  - averageScores remain 0 (no review yet)
  ‚Üì
Teacher reviews Attempt #1 (score: 65)
  ‚Üì
  - averageOverallScore = 65
  ‚Üì
Student submits Attempt #2
  ‚Üì
  - exercisesCompleted += 1
  - totalWordsWritten += wordCount
  - averageScores still 65 (only 1 reviewed)
  ‚Üì
Teacher reviews Attempt #2 (score: 85)
  ‚Üì
  - averageOverallScore = (65 + 85) / 2 = 75
```

### Stats Behavior

| Metric | Behavior with Multiple Attempts |
|--------|--------------------------------|
| Total exercises completed | Increments with each submission |
| Word count | Adds all words from all attempts |
| Average scores | Only calculated from reviewed attempts |
| Streak | One submission per day counts (any attempt) |

## UI Integration

### Student Writing Page

**NEW elements to add**:
1. **Attempt Stats Banner** (top of page when exercise selected)
   - Shows stats using `AttemptStats` component
   - Only visible if user has previous attempts

2. **Attempt History Panel** (collapsible sidebar)
   - Lists all attempts using `AttemptHistory` component
   - Click to view feedback from previous attempts
   - Compare scores across attempts

3. **"Start New Attempt" Button**
   - Always available after first submission
   - Creates new draft with incremented attemptNumber

### Teacher Grading Page

**NEW requirements**:
1. Show ALL attempts per student/exercise
2. Group by student ‚Üí exercise ‚Üí attempts
3. Allow reviewing each attempt independently
4. Display attempt number prominently

## Example Usage

### Creating First Attempt

```typescript
// Student starts writing
const exerciseId = "creative-a1-001";
const userId = "student@test.com";

// Check attempt number (will be 1)
const attemptNumber = await getNextAttemptNumber(userId, exerciseId);
// attemptNumber === 1

// Create submission
await createSubmission({
  userId,
  exerciseId,
  attemptNumber: 1,
  content: "Ich bin...",
  status: 'draft',
  // ...
});
```

### Creating Second Attempt

```typescript
// Student wants to try again
const attemptNumber = await getNextAttemptNumber(userId, exerciseId);
// attemptNumber === 2

// Create new submission
await createSubmission({
  userId,
  exerciseId,
  attemptNumber: 2,
  content: "Ich bin ein Student und...",
  status: 'draft',
  // ...
});
```

### Viewing All Attempts

```typescript
const attempts = await getUserExerciseAttempts(userId, exerciseId);
// Returns:
// [
//   { attemptNumber: 1, status: 'reviewed', teacherScore: 65, ... },
//   { attemptNumber: 2, status: 'submitted', ... },
// ]
```

## Benefits

1. **Student Learning**
   - Students can iterate and improve
   - See progress over multiple tries
   - Compare feedback across attempts

2. **Teacher Insights**
   - Track student improvement over time
   - See if feedback is being applied
   - Identify persistent mistakes

3. **Motivation**
   - Students not limited to one try
   - Can recover from poor first attempt
   - Encourages revision and practice

## Edge Cases

### Scenario 1: Student has draft, creates new one
**Solution**: `hasDraftAttempt()` checks for existing draft and resumes it instead of creating duplicate

### Scenario 2: Student submits multiple times same day
**Solution**: Each submission counts toward daily stats (intentional - rewards practice)

### Scenario 3: Teacher reviews out of order
**Solution**: Each attempt is independent - reviewing Attempt #3 doesn't affect Attempt #1

### Scenario 4: Student deletes an attempt
**Solution**: Attempt numbers never change - if Attempt #2 deleted, next is still #4 (not #3)

## Implementation Status

### ‚úÖ Complete
- Data model updated with `attemptNumber`
- `writingAttemptService.ts` created
- Submission handlers updated
- Components created (`AttemptHistory`, `AttemptStats`)
- Hooks created (`useWritingAttempts`)

### ‚ö†Ô∏è Needs Integration
- Add `AttemptStats` to student writing page
- Add `AttemptHistory` to student writing page
- Add "Start New Attempt" button
- Update teacher grading UI to show all attempts
- Update progress tracking (verify behavior with multiple attempts)

### üìù Needs Testing
- Create first attempt ‚Üí verify attemptNumber = 1
- Create second attempt ‚Üí verify attemptNumber = 2
- Resume draft ‚Üí verify doesn't create duplicate
- Submit multiple attempts ‚Üí verify stats update correctly
- Teacher reviews multiple attempts ‚Üí verify each gets independent feedback

## Summary

The multiple attempts system allows students to:
- ‚úÖ Submit the same exercise multiple times
- ‚úÖ Get separate reviews for each attempt
- ‚úÖ Track improvement over time
- ‚úÖ See statistics (average score, best score, etc.)

Each attempt is fully independent with its own:
- Firestore document
- Attempt number
- Status (draft/submitted/reviewed)
- Teacher review
- Peer reviews
- Scores and feedback
