name: Rebrand Application

# This workflow allows you to rebrand the application from GitHub's web interface
# Go to: Actions â†’ Rebrand Application â†’ Run workflow
# Fill in the form and click "Run workflow"

on:
  workflow_dispatch:
    inputs:
      brand_name:
        description: 'New Brand Name (e.g., "MyApp")'
        required: true
        type: string
      domain:
        description: 'New Domain (e.g., "myapp.com" - no https://)'
        required: true
        type: string
      folder_name:
        description: 'Folder Name (optional, auto-generated if empty)'
        required: false
        type: string
      bucket_name:
        description: 'R2 Bucket Name (optional, auto-generated if empty)'
        required: false
        type: string
      database_name:
        description: 'Database Name (optional, auto-generated if empty)'
        required: false
        type: string
      tagline:
        description: 'Tagline (optional, e.g., "Your Custom Tagline")'
        required: false
        type: string
      description:
        description: 'Description (optional, for SEO)'
        required: false
        type: string
      create_github_repo:
        description: 'Create new GitHub repository?'
        required: true
        type: boolean
        default: false
      update_git_remote:
        description: 'Update git remote URL?'
        required: true
        type: boolean
        default: false
      github_username:
        description: 'GitHub Username (required if creating repo)'
        required: false
        type: string
      commit_and_push:
        description: 'Automatically commit and push changes?'
        required: true
        type: boolean
        default: true

jobs:
  rebrand:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸŽ¨ Run Rebrand Script
        run: |
          # Build rebrand command
          CMD="npm run rebrand -- --name \"${{ inputs.brand_name }}\" --domain \"${{ inputs.domain }}\""

          # Add optional parameters
          if [ -n "${{ inputs.folder_name }}" ]; then
            CMD="$CMD --folder \"${{ inputs.folder_name }}\""
          fi

          if [ -n "${{ inputs.bucket_name }}" ]; then
            CMD="$CMD --bucket \"${{ inputs.bucket_name }}\""
          fi

          if [ -n "${{ inputs.database_name }}" ]; then
            CMD="$CMD --database \"${{ inputs.database_name }}\""
          fi

          if [ -n "${{ inputs.tagline }}" ]; then
            CMD="$CMD --tagline \"${{ inputs.tagline }}\""
          fi

          if [ -n "${{ inputs.description }}" ]; then
            CMD="$CMD --description \"${{ inputs.description }}\""
          fi

          echo "ðŸš€ Running: $CMD"
          eval $CMD

      - name: ðŸ“Š Generate Summary
        run: |
          FOLDER_NAME="${{ inputs.folder_name }}"
          if [ -z "$FOLDER_NAME" ]; then
            FOLDER_NAME=$(echo "${{ inputs.brand_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/^-\|-$//g')-web-v2
          fi

          echo "## ðŸŽ‰ Rebranding Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Applied:" >> $GITHUB_STEP_SUMMARY
          echo "- **Brand Name:** ${{ inputs.brand_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Domain:** ${{ inputs.domain }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Folder:** $FOLDER_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modified Files:" >> $GITHUB_STEP_SUMMARY
          git status --short >> $GITHUB_STEP_SUMMARY

      - name: ðŸ™ Create GitHub Repository
        if: ${{ inputs.create_github_repo == true }}
        run: |
          FOLDER_NAME="${{ inputs.folder_name }}"
          if [ -z "$FOLDER_NAME" ]; then
            FOLDER_NAME=$(echo "${{ inputs.brand_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/^-\|-$//g')-web-v2
          fi

          USERNAME="${{ inputs.github_username }}"
          if [ -z "$USERNAME" ]; then
            USERNAME="${{ github.repository_owner }}"
          fi

          echo "ðŸ“¦ Creating repository: $USERNAME/$FOLDER_NAME"

          # Create repository using GitHub API
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{\"name\":\"$FOLDER_NAME\",\"private\":true,\"description\":\"${{ inputs.description }}\"}" || echo "âš ï¸ Repository may already exist"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… New Repository Created:" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/$USERNAME/$FOLDER_NAME" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”— Update Git Remote
        if: ${{ inputs.update_git_remote == true }}
        run: |
          FOLDER_NAME="${{ inputs.folder_name }}"
          if [ -z "$FOLDER_NAME" ]; then
            FOLDER_NAME=$(echo "${{ inputs.brand_name }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/^-\|-$//g')-web-v2
          fi

          USERNAME="${{ inputs.github_username }}"
          if [ -z "$USERNAME" ]; then
            USERNAME="${{ github.repository_owner }}"
          fi

          NEW_REMOTE="https://github.com/$USERNAME/$FOLDER_NAME.git"

          echo "ðŸ”— Updating git remote to: $NEW_REMOTE"
          git remote set-url origin $NEW_REMOTE

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Git Remote Updated:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "origin: $NEW_REMOTE" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¾ Commit and Push Changes
        if: ${{ inputs.commit_and_push == true }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"

          git add .

          # Create commit message
          cat > /tmp/commit-msg.txt << 'EOF'
          Rebrand to ${{ inputs.brand_name }}

          Automated rebranding via GitHub Actions workflow.

          Changes:
          - Brand name: ${{ inputs.brand_name }}
          - Domain: ${{ inputs.domain }}
          - Folder: ${{ inputs.folder_name || 'auto-generated' }}

          Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>
          EOF

          git commit -F /tmp/commit-msg.txt

          # Push to current or new remote
          git push origin HEAD:${{ github.ref_name }} || git push -u origin HEAD:${{ github.ref_name }}

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Changes Committed and Pushed" >> $GITHUB_STEP_SUMMARY
          echo "View commit: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Next Steps
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Update Environment Variables** (.env files)" >> $GITHUB_STEP_SUMMARY
          echo "   - \`NEXT_PUBLIC_DOMAIN=${{ inputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Update R2 and database URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Create Cloudflare R2 Bucket**" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: \`${{ inputs.bucket_name || 'auto-generated' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Copy files from old bucket" >> $GITHUB_STEP_SUMMARY
          echo "   - Update CORS settings for \`${{ inputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Create Turso Database**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   turso db create ${{ inputs.database_name || 'auto-generated' }}" >> $GITHUB_STEP_SUMMARY
          echo "   turso db show ${{ inputs.database_name || 'auto-generated' }} --url" >> $GITHUB_STEP_SUMMARY
          echo "   turso db tokens create ${{ inputs.database_name || 'auto-generated' }}" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Update Vercel**" >> $GITHUB_STEP_SUMMARY
          echo "   - Project name and environment variables" >> $GITHUB_STEP_SUMMARY
          echo "   - Add domain: \`${{ inputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "5. **Update Firebase** (if used)" >> $GITHUB_STEP_SUMMARY
          echo "   - Update lib/firebase.ts with new project ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "6. **Update Google OAuth**" >> $GITHUB_STEP_SUMMARY
          echo "   - Add authorized domain: \`${{ inputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Update callback URL: \`https://${{ inputs.domain }}/api/auth/callback/google\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "7. **Update DNS Records**" >> $GITHUB_STEP_SUMMARY
          echo "   - Point \`${{ inputs.domain }}\` to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "8. **Deploy**" >> $GITHUB_STEP_SUMMARY
          echo "   - Merge to main branch or deploy manually" >> $GITHUB_STEP_SUMMARY
